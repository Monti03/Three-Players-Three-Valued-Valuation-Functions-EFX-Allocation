\documentclass{article}
\usepackage[utf8]{inputenc}
\usepackage{amsmath}



%%%%%%%%%%Added these packages-Commands%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\usepackage{graphicx}
\usepackage{booktabs}
\usepackage[ruled,vlined,linesnumbered]{algorithm2e}
\usepackage{enumitem}
\usepackage{libertine}
\usepackage{amssymb,amsmath,amsfonts,amstext,amsthm}
\usepackage{hyperref}
\usepackage[svgnames]{xcolor}
\usepackage[capitalise,nameinlink]{cleveref}
\hypersetup{colorlinks={true},linkcolor={DarkBlue},citecolor=[named]{DarkGreen}}
\usepackage{tikz}
\newcommand{\gb}[1]{{\color{red}[GB: #1]}}
%%%%%%%%%%%%%%%%End of the added packages-Commands%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%






\usepackage{biblatex} %Imports biblatex package
\addbibresource{refs.bib} %Import the bibliography file

\title{Match and Freeze algorithm with three values valuation functions}
\author{Francesco Montano}

\begin{document}

\maketitle

\section{Counter Example For Three Values For The Match And Freeze Algorithm}
The Match and Freeze algorithm is an algorithm introduced in \cite{DBLP:journals/corr/abs-2001-09838} that computes EFX allocations for $n$ players with additive valuation functions with two values. We can see in the next example that the algorithm does not work with three values valuation functions even with only two players. The match and freeze counter example for three values is the following one: let's consider the case in which there are $m=5$ items and two players $p_1$, $p_2$ with the valuations of the items expressed in Table \ref{table:counter-example-match-and-freeze-three-values}. By considering $a = 100$, $b=50$ and $c=1$ the output of the algorithm is $A_1 = \{i_1\}$, $A_2 = \{i_2,i_3, i_4,i_5\}$ where $A_i$ is the sets of items $p_i$ takes. This is not an EFX allocation since $v_1(A_1) = 100 < v_1(A_2\setminus \{i_{5}\}) = 150$. 


\begin{table}[h]
\centering
\begin{tabular}{|l|l|l|l|l|l|}
\hline
      & $i_1$ & $i_2$ & $i_3$ & $i_4$ & $i_5$ \\ \hline
$p_1$ & $a$   & $b$   & $b$   & $b$   & $b$   \\ \hline
$p_2$ & $b$   & $c$   & $c$   & $c$   & $c$   \\ \hline
\end{tabular}
\label{table:counter-example-match-and-freeze-three-values}
\end{table}

\section{Match And Freeze Modification}
In this section we try to modify the Match and Freeze algorithm in order to obtain an EFX allocation with additive valuation functions with three values for only two players. The first thing that we notice from the counter example used before, is that the problem with three values is that the frozen player $p_1$ can envy the non frozen player $p_2$ since while $p_1$ is frozen, $p_2$ has to get $\left \lfloor \frac{b}{c}\right \rfloor -1$ items with value $c$ but that can have value $b$ for $p_1$, so the value of the items taken by $p_2$ while $p_1$ is frozen for $p_1$ can be $\left \lfloor \frac{b}{c}\right \rfloor b - b$ that is higher than $a$ if $\left \lfloor \frac{b}{c}\right \rfloor > \left \lfloor \frac{a}{b}\right \rfloor$
\gb{Rephrase this a bit: The actual problem is that $p_2$ needs to take too many goods of value c in order to "catch" $p_1$. While this happens, $p_1$ loses to much  value because $p_2$ takes items that have value b for her. Highlight that the problem is that the multiplicative distance between a and b, is much smaller than the one of b and c)}. 
In order to solve this problem the first idea has been to run the algorithm till the end and then, if the produced allocation is not EFX
, go back to the assignment that froze the first player and assign the item that went to $p_1$ to $p_2$ and vice versa.
Moreover we have to redefine the number of iterations for which a player is frozen in order to adapt it to the three value case. In this case we will have a variable number of iterations that depends on the remaining items and on the values obtained by the two players. Without loss of generality let's consider that $p_1$ took item $x$ and $p_2$ took item $y$,
\gb{Instead of having $k$ and $l$ which is a bit confusing, you can say that w.l.o.g. $p_1$ was assigned with item $x$ and $p_2$ was assigned with item $y$}
the cases in which we freeze player $p_1$ are: 
\begin{itemize}
    \item $v_2(x) = a,\; v_2(y) =  b$ in this case we have that $p_2$ can still take items with value $b$ and $c$. We will unfroze $p_1$ only when $p_2$ has obtained a set of items $F$ while $p_1$ is frozen such that
    \begin{equation}
        a-b\ge v_2(F)\ge a-b-c
        \label{eq:constraint-value-freeze-a-b-c}
    \end{equation}
    The set of items $F$ is obtained by first taking all the items with value $b$ for $p_2$ by respecting that $a-b\ge v_2(F)$, than by taking items with value $c$ for $p_2$ in order to respect the constraint described in equation \ref{eq:constraint-value-freeze-a-b-c}.
    \gb{Rephrase this a bit: Take every item of value b, and reach...}
    \gb{Rephrase this a bit: It is not that clear to me what you mean}
    \item $v_2(x) = a,\; v_2(y) =  c$ in this case we have that $p_2$ can still take items only with value $c$, so $p_1$ will be frozen for $\left\lfloor \frac{a-c}{c}\right \rfloor =\left \lfloor \frac{a}{c}\right \rfloor - 1$.
    \item $v_l(x) = b,\; v_l(y) =  c$ in this case we have that $p_l$ can still take items only with value $c$, so $p_k$ will be frozen for $\left \lfloor \frac{b-c}{c}\right \rfloor =\left  \lfloor \frac{b}{c}\right \rfloor - 1$.
\end{itemize}
In order to show that this approach is effective, we have to better define the kind of assignment that could lead to a non EFX allocation at the end, so also show that the other assignment will lead always to an EFX allocation, and that by changing the assignment if the obtained result is not EFX, that we obtain surely an EFX allocation.
\paragraph{}
We can define a problematic assignment as an assignment after which $p_i$ is frozen and there are still items that $p_i$ values as $b$. Now let's show that if this kind of assignment does not appear during the execution of the algorithm, the final allocation will be EFX. If we consider that there are no problematic assignments, we can have two cases
\begin{enumerate}
    \item No player will be frozen
    \item Freeze only players who can still take only items with value $c$ 
\end{enumerate}

Is easy to see that in the first case we will have an EFX allocation since $v_1(A_1[l])\ge v_1(A_2[l])\; \forall l \in \{1,2,\cdots,k\}$ where $k = \min (|A_1|, |A_2|)$ where $A_i[j]$ is the $j$-th item took by player $i$ (the same holds for $p_2$).
So we have that if $p_1$ and $p_2$ get the same number of items they are envy-free, otherwise they are EFX since the last item taken by one of the two players will have the smallest value for the other player.\\
In the second case we can observe that only one player will be frozen during the execution of the algorithm because if there are no problematic assignments, when a player $p_i$ is frozen, then it can only take items with value $c$ for him
\gb{Value c for whom? You probably mean that if a player is frozen, then the other player can take items that have value c for the frozen player?}
so the algorithm will not generate other assignments in which a player can be frozen, indeed the only type of assignment that can generate a second freeze needs to have both players with an item with value $b$ like shown in Table \ref{table:bbcc-block}. In order to show that only when there are problematic assignments the algorithm can generate non EFX allocations we have to show that when a player is frozen but all the remaining items have value $c$ for him, then the algorithm will produce an EFX allocation.
Let's consider that at iteration $i$ the algorithm freezes $p_1$, before iteration $i$ we have that $v_1(A_1[l])\ge v_1(A_2[l]) \; \forall l \in \{1,2,\cdots, i-1\}$ and $v_2(A_2[l]) \ge v_2(A_1[l])\;\forall l \in \{1,2,\cdots,i-1\}$,  instead from the iteration in which $p_1$ is unfrozen, $p_2$ takes a number of items that is $z$ while $p_1$ will take or $z$ or $z-1$ items since at the end we give precedence to the player that has not been frozen.
\gb{So here we want to say that before player $i$ is frozen, both players do not envy each other, while after $p_1$ is unfrozen both players will get almost the same number of items.}
Let's define $F$ to be the set of items that $p_2$ has taken while $p_1$ was frozen and let's analyze the different cases:
\gb{This $F$ is the same as the one that was defined before? TO DO: Check the notation again. Also we can name items just x and y for convenience or have indexes $h$ for high and $l$ for low, so that it is easier for the reader to follow.}
\begin{enumerate}
    \item $p_1$ took item $x: v_1(x) = a$
    \begin{enumerate}
        \item $p_2$ took item $y:v_2(y) = b$ and $v_2(x) = a$ \label{enumerate:non-problematic-assigment-case-aba}
        %\begin{itemize}
            %\item $p_1$ EFX to $p_2$: we have that the larger amount of iterations that $p_1$ can be frozen is $\lfloor \frac{a-b}{c}\rfloor$ so in this case $v_1(F) \le \lfloor \frac{a-b}{c}\rfloor c \le a-b$. This implies that $v_1(A_1) \ge v_1(A_1^*) + a + (z-1) c$. Instead for what concerns the valuation of player $p_1$ for the items obtained by $p_2$ we can write the following: 
            %\begin{align*}
%v_1(A_2) &\le v_1(A_2^*) + b + v_1(F) + zc\\&\le v_1(A_1^*) + b + a - b + zc = (i-1)a + a + zc      
%\end{align*}    
        %\end{itemize}
        \item $p_2$ took item $y: v_2(y) = c$ and $v_2(x) = a$ \label{enumerate:non-problematic-assigment-case-aca}
        \item $p_2$ took item $y: v_2(y) = c$ and $v_2(x) = b$ \label{enumerate:non-problematic-assigment-case-acb}
    \end{enumerate}
    \item $p_1$ took item $x: v_1(x) = b$
    \begin{enumerate}
        \item $p_2$ took item $y: v_2(y) = c$ and $v_2(x) = b$
        \label{enumerate:non-problematic-assigment-case-bcb}
    \end{enumerate}
\end{enumerate}
%By considering $F$ to be the set of items that $p_2$ takes while $p_1$ is frozen, we have that $v_1(f) \le v_2(f) \; \forall f\in F$. So we 
%We can see that in this case $p_2$ is also EFX towards $p_1$ since $v_2(A_2) \ge (i-1)a + b + v_2(F) + zc= (i-1)a  + a + (z-1)c$ since $v_2(F)\ge a-b-c$ and 
%\begin{align*}
%v_2(A_1) &\le (i-1)a + a + zc = (i-1)a + a + zc      
%\end{align*}
%So also $p_2$ is EFX towards $p_1$.
%\\
%In case $1.b$ instead we have that the the number of iterations in which $p_1$ is frozen is $\lfloor \frac{a-c}{c}\rfloor$ so in this case $v_1(F) = \lfloor \frac{a-c}{c}\rfloor c \le a-c$. So in this case we have that
%v_1(A_1) \ge (i-1)a + a + (z-1) c$, while 
%\begin{align*}
%v_1(A_2) &\le (i-1)a + b + v_1(F) + zc\\&\le (i-1)a + b + a - c + zc = (i-1)a + a + zc      
%\end{align*}
%So we have that $p_1$ is EFX towards $p_2$
We can see in all the above cases that, since $p_1$ values all the remaining items as $c$, he will always be EFX towards $p_2$.
\paragraph{Case 1c and 2a}
Instead for what concerns $p_2$ in the case \ref{enumerate:non-problematic-assigment-case-acb} and \ref{enumerate:non-problematic-assigment-case-bcb} we can observe that at the end of the algorithm the set of items obtained by $p_2$: $A_2$ will be formed by $A_2^*$ that is the set of items obtained by $p_2$ before that $p_1$ is frozen, item $y$ obtained in the iteration in which $p_1$ is frozen, the set of items $F$ that contains the items obtained by $p_2$ while $p_1$ was frozen and $z$ items with value $c$ obtained from the iteration in which $p_1$ is unfrozen. Instead we have that $A_1$ will be formed by $A_1^*$, item $x$ that $p_1$ obtained in the iteration that causes him to be frozen and at most $z$ items with value $c$ for both players obtained after that he has been unfrozen. We can notice that case  \ref{enumerate:non-problematic-assigment-case-acb} and \ref{enumerate:non-problematic-assigment-case-bcb} we can write $v_2(F) > b-2c$, so we have that 
\gb{Although I understand the point of these equations, the notation is not clear and some things have to be introduced earlier, e.g. What is $A^*$}
\begin{align*}
    v_2(A_2) &= v_2(A_2^*) + v_2(y) + v_2(F) + zc\\
    &= v_2(A_2^*) + c + v_2(F) + zc > v_2(A_2^*) + b-c + zc\\
    \\
    v_2(A_1) &= v_2(A_1^*) + v_2(x) + zc\\
    &=v_2(A_1^*) + b + zc\le v_2(A_2^*) + b + zc
\end{align*}
\gb{You explain what $A^*$ is here, but as I said maybe is better to introduce is earlier. Add that index $k \in \{1,2\}$}
Where we have that $v_2(A_1^*)\le v_2(A_2^*)$.
So the allocation produced by the algorithm in the case \ref{enumerate:non-problematic-assigment-case-acb} and \ref{enumerate:non-problematic-assigment-case-bcb} is EFX.

\paragraph{Case 1b}
In case  \ref{enumerate:non-problematic-assigment-case-aca} we obtain the same thing as for the case  \ref{enumerate:non-problematic-assigment-case-acb} and \ref{enumerate:non-problematic-assigment-case-bcb} described above, with the only difference that $v_2(F) > a-2c$, so we have that 
\gb{I am a bit lost with which case is examined e.g. you say that in the second case we obtain the same thing as in the last two cases. This is confusing, I would say that it is better to use the names of the cases so that it is clear to the reader.}
\begin{align*}
    v_2(A_2) &= v_2(A_2^*) + v_2(y) + v_2(F) + zc\\
    &= v_2(A_2^*) + c + v_2(F) + zc > v_2(A_2^*) + a-c + zc\\\\
    v_2(A_1) &= v_2(A_1^*) + v_2(x) + zc\\
    &=v_2(A_1^*) + a + zc\le v_2(A_2^*) + a + zc
\end{align*}
So also in case \ref{enumerate:non-problematic-assigment-case-aca} we have an EFX allocation.
\gb{Again here I am not sure what case we examine, it would be nicer to break the proof into cases where each case has its own proof. After that we can see if the cases can be unified.} 
\paragraph{Case 1a}
In case \ref{enumerate:non-problematic-assigment-case-aba} by considering the constraint defined in equation \ref{eq:constraint-value-freeze-a-b-c} we have that $a-b\ge v_2(F)\ge a-b-c$. After that $p_1$ is unfrozen, we can have that there are still items valued as $b$ from $p_2$. In this case so we have that the items obtained after that $p_1$ is unfrozen have to be divided in $z_{b, 1}$, $z_{c, 1}$, $z_{b, 2}$ and  $z_{c, 2}$ respectively as the items with value $b$ and $c$ for $p_2$ obtained by player $p_1$ and $p_2$.
\gb{$n$ here is the index of the player? If so use a different letter, usually $n$ denotes the number of the players. The same goes for $m$, this is usually the number of the items and not their value} So we can write the following considering that the non frozen players have the precedence at the last iteration
\begin{align*}
z_{b,1} = \begin{cases} 
z_{b,2} &\implies z_{c,1} = \begin{cases} 
z_{c,2}\\
z_{c,2} -1
\end{cases}   \\
z_{b,2} -1 &\implies z_{c,1} = \begin{cases} 
z_{c,2}\\
z_{c,2} +1
\end{cases}   
\end{cases}
\end{align*}
The worst case to consider is when $z_{b,1} = z_{b,2} = z_b$ and $z_{c,1} = z_{c,2} = z_c$. In this case we have that $A_1$ is formed by $A_1^*$, item $x$ obtained in the iteration that causes $p_1$ to be frozen, $z_b$ and $z_c$ as the items obtained after that he has been unfrozen with value $b$ and $c$ for $p_2$. Instead $A_2$ is formed by $A_2^*$, item $y$ obtained in the iteration that causes $p_1$ to be frozen, $F$ the set of items obtained while $p_1$ was frozen and $z_b$ and $z_c$ as the items obtained after that he has been unfrozen respectively with value $b$ and $c$ for $p_2$. So we can write that 
\begin{align*}
    v_2(A_2) &= v_2(A_2^*) + v_2(y) + v_2(F) + z_b b + z_cc\\
    &= v_2(A_2^*) + b + v_2(F) + z_bb +  z_cc > v_2(A_2^*) + a-c + z_b b + z_cc\\\\
    v_2(A_1) &= v_2(A_1^*) + v_2(x) + z_bb + z_cc \\
    &=v_2(A_1^*) + a + z_bb + z_cc\le v_2(A_2^*) + a + z_bb + z_cc
\end{align*}
So also in case \ref{enumerate:non-problematic-assigment-case-aba} the algorithm produces EFX allocations.
\gb{I believe that these cases can be unified as the arguments are kind of similar, the only difference is on whether there are just items with values $c$, or items with value $b$ and $c$. Although I think that I get the general idea, most of the proof should be rewritten in a way so that it is clear which case is examined each time. The notation should be also changed as in many places is a bit confusing.}

\paragraph{}
Now what remains to show is that if after a problematic assignment we obtain a non EFX allocation, than we can go back, change the assignment, run the algorithm and obtain an EFX allocation. 
The possible problematic assignments are shown in Table \ref{table:problematic-assignments-2-players}:
\begin{table}[h]
    \footnotesize
 
        \centering
       \begin{tabular}{|l|l|l|}
            \hline
            $p_1$ & $a$ & $b$ \\ \hline
            $p_2$ & $b$ & $c$ \\ \hline
        \end{tabular}
        \;\;\;\;\;\;\;\;\;\;\;\;
        \centering
        \begin{tabular}{|l|l|l|}
            \hline
            $p_1$ & $a$ & $b$ \\ \hline
            $p_2$ & $a$ & $b$ \\ \hline
        \end{tabular}
        
        \caption{Problematic Assignments}
        \label{table:problematic-assignments-2-players}
    \end{table}
    
\subsection{First Problematic Assignment}
\begin{table}[]
    \centering
    \begin{tabular}{|l|l|l||l|}
    \hline
    $p_1$ & \textbf{a} & $b$ & $b$        \\ \hline
    $p_2$ & $b$        & $c$ & \textbf{b} \\ \hline
    \end{tabular}
    \label{table:first-problem-association-show-no-double-freeze-first}
    \caption{Assignment that shows that with the first problematic assignment we cannot have two frozen players or one player frozen twice}
\end{table}

\gb{Aris also commented on this last time, the numbering  in the equations should be removed. Keep only the numbering the is useful as the proof goes on.}
Let's start by showing that like in the precedent cases without problematic assignment, we have that only one player per run can be frozen. As first thing we can notice that in order to have a second freeze we must have that there is the assignment shown in Table \ref{table:bbcc-block}, so we need to have an item valued by both players $b$ after that a player has been frozen; but if this happens, than we had not followed the maximum matching in the first execution of the algorithm since we could have assigned the items as shown in Table \ref{table:first-problem-association-show-no-double-freeze-first} in bold. Indeed we have that $a+b > b + b$ and $a+b > a+c$.

Let's consider the first problematic assignment and that $a + c \ge b + b$: in this case by running the algorithm we obtain the following valuations for the two players
\begin{align*}
    v_1(A_1) &= v_1(A_1^*) + a + w_b b + w_c c\\
    v_2(A_1) &= v_2(A_2^*) + c + v_2(F_1)+ w_b c + w_c c
\end{align*}
where $A_i^*$ is the set of items obtained in the iterations before the problematic assignment by $p_i$, $w_b$ and $w_c$ are respectively the number of items with value $b$ and $c$ obtained by $p_1$ after that he has been unfrozen and $F_1$ is the set of items obtained by $p_2$ while $p_1$ was frozen. If we consider that after that the frozen player is unfrozen, both player get the same number of items in order to have an EFX allocation we must respect the following two constraints since we assume that in the last iteration the non frozen player has the precedence. 
\gb{why in the first equation you use the envy free definition?}
\begin{align}
    v_1(A_1) &\ge v_1(A_2)\label{eq:condition-1-a1>a2-ch1-first-block-ac-assignment}\\
    v_2(A_2) &\ge v_2(A_1) - c\label{eq:condition-1-a2>a1-c-ch1-first-block-ac-assignment}
\end{align}
In this case we have that the set of items $A_1$ will contain $A_1^*$, the item $x$ such that $v_1(x) = a$ and $v_2(x) = b$ that has been obtained by $p_1$ in the iteration that causes $p_1$ to be frozen, $w_b$ and $w_c$ items obtained by $p_1$ after that has been unfrozen that have value $b$ and $c$ respectively for $p_1$. Instead $A_2$ will contain $A_2^*$, the item $y$ such that $v_1(y) = b$ and $v_2(y) = c$ that has been obtained by $p_2$ in the iteration that causes $p_1$ to be frozen, $w_b$ and $w_c$ items obtained by $p_1$ after that has been unfrozen that have value $b$ and $c$ respectively for $p_1$.
In order to respect the condition in \ref{eq:condition-1-a1>a2-ch1-first-block-ac-assignment} we must have that:
\begin{align*}
    v_1(A_1) &\ge v_1(A_2)\\
    v_1(A_1^*) + v_1(x) + w_b b + w_c c &\ge  v_1(A_2^*) + v_1(y) + v_1(F_1)+ w_b b + w_c c \\
    a  &\ge  b + v_1(F_1)
\end{align*}
\gb{The right part of the second inequality has to be explained}
where we are considering $v_1(A_1^*) = v_1(A_2^*)$ cause this is the worst possible case since we always have that $v_1(A_1^*) \ge v_1(A_2^*)$ since these set of items are referred to the iterations before that a player has been frozen, so at each of these iterations we have that the item obtained by player $1$ has a larger or equal value to the item obtained by player $2$ for player $1$ (the same holds for $p_2$).
\gb{Why is this the worst case?}
Instead in order to have that the condition in equation \ref{eq:condition-1-a2>a1-c-ch1-first-block-ac-assignment} we must have that
\gb{Explain the right part of the second inequality here as well}
\begin{align*}
    v_2(A_2) &\ge v_2(A_1) -c\\
    v_2(A_2^*) + c + v_2(F_1)+ w_b c + w_c c &\ge v_2(A_1^*) + b + w_b c + w_c c - c\\
    c  + v_2(F_1)&\ge  b - c 
\end{align*}
where we can notice that the items relative to the counters $w_b$ and $w_c$ have value $c$ for $p_2$ since he after the freeze can only take items with that value.
This condition is always true since $ c  + v_2(F_1) =\left \lfloor \frac{b}{c}\right\rfloor c > b-c$. So the only possible problem is the first condition: $a \ge  b + v_1(F_1)$. Since in $F_1$ there are the items taken by $p_2$ while $p_1$ is frozen, there can be items valued $b$ by $p_1$; let's consider that we first assign to $p_2$ in $F$ the items valued $b$ by $p_1$ that have not yet assigned before the problematic assignment. In this case we can write
\begin{align*}
    v_1(F_1) = kb + \left\lfloor \frac{b-c-kc}{c}\right\rfloor c = kb + (\left\lfloor \frac{b}{c}\right\rfloor -1-k)c
\end{align*}
where $k$ is the number of items valued $b$ by $p_1$ that are in $F_1$ and $\lfloor \frac{b-c-kc}{c}\rfloor$ are the remaining items valued $c$ by $p_1$ that $p_2$ needs to reach $v_2(F_1)  = \lfloor \frac{b-c}{b}\rfloor c$. So we can write the condition in equation \ref{eq:condition-1-a1>a2-ch1-first-block-ac-assignment} as $a \ge b +kb + (\lfloor \frac{b}{c}\rfloor -1-k)c $, that is equivalent to 
\begin{align}
    k \le \frac{a + c - b - \lfloor \frac{b}{c}\rfloor c }{b-c}
    \label{eq:condition-1-a1>a2-ch1-first-block-ac-assignment-on-k}
\end{align}

If we change the problematic assignment we have that we will break the maximum matching rule and we will freeze $p_2$ rather than $p_1$. In this case we are considering $w_b$ and $w_c$ as the number of items with value $b$ and $c$ for $p_1$ respectively that $p_1$ take after that $p_2$ has been unfrozen, so we have that the valuation for the two players will be 
\gb{Mention here that this violates the maximum matching rule. In addition, in the next inequalities, $w_b$ and $w_c$ mean the same thing as before?}
\begin{align*}
    v_1(A_1) &= v_1(A_1^*) + b + v_1(F_2) + w_b b + w_c c\\
    v_2(A_1) &= v_2(A_2^*) + b + w_b c + w_c c
\end{align*}
The conditions in order to have an EFX allocation now become the following ones, since in this case $p_1$ will have the precedence in the last iteration: 
\begin{align}
    v_1(A_1) &\ge v_1(A_2) - c\label{eq:condition-1-a1>a2-ch1-first-block-bb-assignment}\\
    v_2(A_2) &\ge v_2(A_1)\label{eq:condition-1-a2>a1-c-ch1-first-block-bb-assignment}
\end{align}
In this case we have that $A_1$ will contain $A_1^*$, the item $y$ obtained in the iteration in which we freeze $p_2$ such that $v_1(y) =  b$ and $v_2(y) = c$, $F_2$ as the set of items obtained by $p_1$ while $p_2$ is frozen and $w_b$ and $w_c$ items obtained by $p_1$ after that $p_2$ has been unfrozen that have value $b$ and $c$ respectively for $p_1$. Instead $A_2$ will contain $A_2^*$, the item $x$ obtained in the iteration in which we freeze $p_2$ such that $v_1(x) =  a$ and $v_2(x) = b$ and $w_b$ and $w_c$ items obtained by $p_2$ after that has been unfrozen that have value $b$ and $c$ respectively for $p_1$. So the first condition is equivalent to 
\begin{align*}
    v_1(A_1) &\ge v_1(A_2) -c\\
    v_1(A_1^*) + v_1(y) + v_1(F_2)+ w_b b + w_c c &\ge v_2(A_1^*) + v_1(x) + w_b b + w_c b - c\\
    b  + v_1(F_2)&\ge  a - c 
\end{align*}
That is always true since $ v_1(F_2) \ge  a-b-c$ as defined in equation \ref{eq:constraint-value-freeze-a-b-c}. So now we have to check the condition for which $p_2$ is EFX towards $p_1$.
\begin{align*}
    v_2(A_2) &\ge v_2(A_1)\\
    v_2(A_2^*) + v_2(x) + w_b c + w_c c &\ge  v_2(A_1^*) + v_2(y) + v_2(F_2)+ w_b c + w_c c\\
    b  &\ge  c + v_2(F_2)
\end{align*}
We can notice that $v_2(F_2) = kc + \lfloor \frac{a-b-kb}{c} \rfloor c$ since, as said before, $k$ is the minimum number of items that are surely present with value $b$ for $p_1$ after the problematic assignment, so the other values that are used to reach the constraint $v_1(F_2) \ge a-b-c$ are in the worst case items with value $c$ for $p_1$. We can also notice that all these items have value $c$ for $p_2$ since he already took an item with value $c$, so there are no other items with value $b$ or $a$. So we have that the condition in equation \ref{eq:condition-1-a2>a1-c-ch1-first-block-bb-assignment} becomes
\begin{align*}
    v_2(A_2) &\ge v_2(A_1)\\
     b  &\ge  c + v_2(F_2)\\
      b  &\ge  c +  kc + \left\lfloor \frac{a-b-kb}{c} \right\rfloor c\\
      b  &\ge  c +  kc + a-b-kb\\
      \frac{a + c -2b}{b-c}  &\le   k
\end{align*}
So the second condition in order to have an EFX allocation by changing the problematic assignment is 
\begin{equation}
    k \ge \frac{a + c -2b}{b-c}
    \label{eq:condition-1-a2>a1-ch1-first-block-bb-assignment-on-k}
\end{equation}
As we can see, equation \ref{eq:condition-1-a1>a2-ch1-first-block-ac-assignment-on-k} and \ref{eq:condition-1-a2>a1-ch1-first-block-bb-assignment-on-k} are complementary on integer values of $k$. So if the algorithm produces a non EFX allocation, by changing the assignment we surely obtain an EFX allocation in the first problematic assignment of table \ref{table:problematic-assignments-2-players}. 
\gb{One question that I have is the following: In the original paper there is the argument that each player can freeze at most once. Is this the case here as well after the proposed modification? If this is not the case, then the arguments about the value that each agent derives after she is unfrozen still hold? For example, is it possible that we start with a problematic block, and when the frozen player becomes active, she can be frozen again? Is this possible? If yes does the proof considers such a case? If no, then shouldn't we prove it?}

\subsection{Second Problematic Assignment}
In order to show that also in this case we obtain an EFX allocation, I will first consider the case of identical valuation functions since is easier to deal with and than I will show that we can reduce a general case to this one. We can easily note that with this type of block we could have two freezes: one caused by this problematic block and one caused than by the block shown in Table \ref{table:bbcc-block}.
\gb{I suppose that my above concern is answered here? If this the case, I suppose that in the beginning of the draft a small discussion should be added that describes why every player can freeze only once, except the case that we examine here.}
\begin{table}[h]
        \centering
        \begin{tabular}{|l|l|l|}
            \hline
            $p_1$ & $b$ & $c$ \\ \hline
            $p_2$ & $b$ & $c$ \\ \hline
        \end{tabular}
        
        \caption{Second block that can cause a freeze when we have the second problematic block}
        \label{table:bbcc-block}
    \end{table}
In this part I am going to use $F_{i,j}$ in order to describe the set of items obtained by the player who took item with value $j$ while the other player $i$ is frozen and also
\begin{align*}
    &k = a\% b\\
    &l = b \% c\\
    &w = k \% c
\end{align*}
where $\%$ is the modulus operation.
\paragraph{Identical Valuation Functions}
Let's consider the case in which we have identical valuation functions and we have that we freeze first $p_1$ and then $p_2$. In this case we can ignore the items that the players took in the iterations in which no player is frozen and the ones that do not lead to freeze one player because in each iteration each player has the same value for both the items assigned. So by considering only the iterations in which a player is frozen and the two that lead to freeze one player we can consider the valuations of each player set as 
\gb{Here you mean that the players have the same amount of alphas in the beginning? Why the first player has only one alpha in his value?}
\begin{align*}
    v(A_1) & = a + c + v(F_{2,c})\\
    v(A_2) & = b + v(F_{1,b}) + b
\end{align*}
where $v(\cdot) = v_1(\cdot) = v_2(\cdot)$. These values comes from the fact that in $A_1$ we have the item valued as $a$ that leads to freeze $p_1$, $c$ is the value of the item obtained when $p_2$ is frozen and $F_{2,c}$ is the set of items obtained when $p_2$ is frozen since $p_1$ took the item with value $c$.
\gb{This should be stated in a more clear way}
Instead in $A_2$ we have the item with value $b$ obtained when $p_1$ is frozen,
\gb{Again this is only one item? If so why?}
$F_{1,b}$ that is the set of items obtained by $p_2$ while $p_1$ is frozen since $p_2$ took the item with value $b$ and $b$ that is the value obtained by $p_2$ before being frozen.
We can write that 
\begin{align}
    v(F_{2,c}) + c &= \left\lfloor \frac{b}{c}\right\rfloor c = b - (b\% c) = b-l \label{v(F2c)+c-identical-valuation-functions-second-block}\\
    v(F_{1,b}) + b &= \left\lfloor \frac{a}{b}\right\rfloor b = a - (a\% b) = a - k  &\textit{ if } \:k = a\% b < c \label{v(F1b)+b-amodb<c-identical-valuation-functions-second-block}\\
    v(F_{1,b}) + b &=\left\lfloor \frac{a}{b}\right\rfloor b + \left\lfloor \frac{a - \left\lfloor \frac{a}{b}\right\rfloor b }{c}\right \rfloor c \label{v(F1b)+b-amodb>c-identical-valuation-functions-second-block} \\&= a-k + \left\lfloor \frac{a- a + k }{c} \right\rfloor c = a - k + \left\lfloor \frac{k}{c}\right\rfloor c \\&= a - k + k - k\% c  = a - w &\textit{ if } \:k = a\% b \ge c
\end{align}
where in equation \ref{v(F1b)+b-amodb<c-identical-valuation-functions-second-block} we are considering that, since $a\% b < c$ than by taking $\left\lfloor\frac{a}{b}\right\rfloor$ items with value $b$ we reach the bound $a-b-c$, while in equation \ref{v(F1b)+b-amodb<c-identical-valuation-functions-second-block} we need to take some items with value $c$ in order to reach it. We can also notice that since we are considering that there is a second freeze, there is a number of items with value $b$ greater or equal to $\left\lfloor\frac{a}{b}\right\rfloor$. 
\gb{If there is no second freeze then we are ok?} (I have added a paragraph after the case of the non identical valuation functions case that deals with this case)
\begin{itemize}
    \item if $k < c$ we have that
    \begin{align*}
        &v(A_1) = a + c + v(F_{2,c}) && v(A_2) = b + v(F_{1,b}) + b\\
        &v(A_1) = a + b-l && v(A_2) = a - k + b
    \end{align*}
    In the case considered above both players get the same number of items after that the last player has been unfrozen, in this case we can see that the allocation is EFX: 
    \begin{align*}
        &v(A_1) \ge v(A_2) -c & -l \ge - k - c\\
        &v(A_2) \ge v(A_1) -c & -k \ge -l -c
    \end{align*}
    that is true since $k<c$ and $l<c$.
    Instead in the case in which we have an item that is taken by a player and not by the other, by assigning it correctly, we can obtain an EFX allocation: if we assign that item to $p_1$ we have that the condition to have an EFX allocation is
    \begin{align*}
        &v(A_1) \ge v(A_2) -c & -l \ge - k - c\\
        &v(A_2) \ge v(A_1) & -k \ge -l 
    \end{align*}
    that is equivalent to have only the condition $k\le l$.
    While if we assign it to $p_2$ the condition to have an EFX allocation is
    \begin{align*}
        &v(A_1) \ge v(A_2) & -l \ge - k\\
        &v(A_2) \ge v(A_1)-c & -k \ge -l -c
    \end{align*}
    that is equivalent to have the condition $l\le k$.
    
    \item if $k \ge c$ we have that
    \begin{align*}
        &v(A_1) = a + c + v(F_{2,c}) && v(A_2) = b + v(F_{1,b}) + b\\
        &v(A_1) = a + b-l && v(A_2) = a - w + b
    \end{align*}
    In the case considered above both players get the same number of items after that the last player has been unfrozen, in this case we can see that the allocation is EFX: 
    \begin{align*}
        &v(A_1) \ge v(A_2) -c & -l \ge - w - c\\
        &v(A_2) \ge v(A_1) -c & -w \ge -l -c
    \end{align*}
    that is true since $w<c$ and $l<c$
    Instead in the case in which we have an item that is taken by a player and not by the other, by assigning it correctly, we can obtain an EFX allocation: if we assign that item to $p_1$ we have that the condition to have an EFX allocation is
    \begin{align*}
        &v(A_1) \ge v(A_2) -c & -l \ge - w - c\\
        &v(A_2) \ge v(A_1) & -w \ge -l 
    \end{align*}
    that is equivalent to have only the condition $w\le l$.
    While if we assign it to $p_2$ the condition to have an EFX allocation is
    \begin{align*}
        &v(A_1) \ge v(A_2) & -l \ge - w\\
        &v(A_2) \ge v(A_1)-c & -w \ge -l -c
    \end{align*}
    that is equivalent to have the condition $l\le w$.
\end{itemize}
\gb{As I understand the arguments in these two cases are kind of the same, let's see if we can unify them}
\paragraph{Non Identical Valuation Functions} 
In the precedent paragraph I have shown that with identical valuation functions, also in the case of two freezes, we still can obtain an EFX allocation by correctly assigning the last item. In this section I am going to show that this holds also for non identical functions.
\gb{In the identical function case, make more clear why we examine this case, mention where you use the fact that both players have the same values over the items,finally give some intuition on how this will help us in the case where the values are not identical}
I am going to show that this holds by showing that we have one of the two following conditions

\begin{itemize}
    \item if we first freeze $p_1$ and than $p_2$ we have that $v_1(F_{1,b})\le v_2(F_{1,b})$
    \item if we first freeze $p_2$ and than $p_1$ we have that $v_2(F_{2,b})\le v_1(F_{2,b})$
\end{itemize}
Let's consider without loss of generality that the first condition holds, than after that $p_1$ is unfrozen, he will not envy $p_2$ since $a-b\ge v_2(F_{1,b}) \ge v_1(F_{1,b})$. Than in the iterations before the freeze of $p_1$  and the ones between the one in which we unfroze $p_1$ and the one in which we freeze $p_2$ we have that since no one is frozen, the value of the items obtained by $p_1$ is higher or equal to the value of the items taken by $p_2$ for $p_1$ (so in the worst case the two values will be the same). Than we have the second freeze, after which all the items are valued $c$ by both players, so as we can see the worst case is the one in which we have identical valuation for $p_1$, this holds also for $p_2$ cause in the iterations before that $p_1$ is frozen and in the ones between the one in which we unfreeze $p_1$ and the one in which we freeze $p_2$, the items obtained by $p_2$ have an higher or equal value to the ones obtained by $p_1$ for $p_2$, and after the second freeze, all the items have value $c$ for both players. So also for $p_2$ the worst case in which we have the two freezes is the one with the identical valuation functions.
We can say the same things inverting $p_2$ and $p_1$ if the second condition holds. So we can reduce this case to the identical values functions case.
\gb{Why this is the worst case? Be more precise here}\\

Let's consider the case in which we freeze first $p_1$, then $p_2$ will take $F_{1,b}$ items while $p_1$ is frozen. Of these items we can have three types of items: 
\begin{enumerate}
    \item item valued by both players as $b$ \label{item:item-valued-bb}%y
    \item item valued by player $p_1$ as $c$ and by $p_2$ as $b$ \label{item:item-valued-cb} %v
    \item item valued by player $p_1$ as $b$ and by $p_2$ as $c$ \label{item:item-valued-bc}%s
\end{enumerate}
The same happens when we have that we freeze $p_2$ and than $p_1$. Let's consider that in both cases we use the same number of items of type \ref{item:item-valued-bb}: $t_{b,b}$, that of type \ref{item:item-valued-cb} we have $t_{c,b}$ items and of type \ref{item:item-valued-bc} we have $t_{b,c}$ items. So we have that in $t_{**}$ the first letter in the subscript is the value for $p_1$, while the second one is the value for $p_2$.\gb{These values are according to which player? Specify this as the players now have non-identical valuations. The notation has to be changed here again, e.g. the letter $v$ is usually used to describe the value, make it $t_j$ depending on the type} 
When freezing $p_1$ we can write that 
\begin{align*}
    v_1(F_{1,b}) &= t_{bb}b + t_{cb}c + \left\lfloor \frac{a-b-yb-vb}{c}\right\rfloor b \\
                & = t_{bb}b + t_{cb}c + \hat{t}_{bc} b\\
    v_2(F_{1,b}) &= t_{bb}b + t_{cb}b + \left\lfloor \frac{a-b-yb-vb}{c}\right\rfloor c \\
                & = t_{bb}b + t_{cb}b + \hat{t}_{bc} c \le a-b
\end{align*}
where $\hat{t}_{b,c}\le t_{b,c}$ is the number of items of type $3$ that $p_2$ needs to achieve the constraint $v_2(F_{1,b})\ge a-b-c$. In this case in order to have $v_1(F_{1,b}) \le v_2(F_{1,b})$ we must have that
\begin{align*}
    v_1(F_{1,b}) &\le v_2(F_{1,b})\\
    t_{bb}b + t_{cb}c + \hat{t}_{bc} b &\le t_{bb}b + t_{cb}b + \hat t_{bc} c\\
    \hat t_{bc}(b-c) &\le t_{cb}(b-c)
\end{align*}
that is surely true when $s\le v$ since $b> c$.\\
Instead if we freeze $p_2$ we have that
\begin{align*}
    v_1(F_{2,b}) &= t_{bb}b + t_{bc}b + \left\lfloor \frac{a-b-yb-sb}{c}\right\rfloor c \\
                & = t_{bb}b + t_{bc}b + \hat t_{cb} c\\
    v_2(F_{2,b}) &= t_{bb}b + t_{bc}c + \left\lfloor \frac{a-b-yb-sb}{c}\right\rfloor b \\
                & = t_{bb}b + t_{bc}c + \hat t_{cb} b \le a-b
\end{align*}
where $ \hat t_{c,b}\le t_{c,b}$ is the number of items of type $2$ that $p_1$ needs to achieve the constraint $v_1(F_{2,b})\ge a-b-c$. In this case in order to have $v_2(F_{2,b}) \le v_1(F_{2,b})$ we must have that
\begin{align*}
    v_2(F_{2,b}) &\le v_1(F_{2,b})\\
    t_{bb}b + t_{bc}c +  \hat t_{cb} b &\le t_{bb}b + t_{bc}b +  \hat t_{c,b} c\\
    \hat t_{cb}(b-c) &\le t_{bc}(b-c)
\end{align*}
that is surely true when $t_{cb}\le t_{bc}$ since $b> c$.\\
\gb{Ok I get what is happening but some thing have to be rewritten in a more clear way, let me think of it.}
So depending on $t_{cb}$ and $t_{bc}$ we can choose the player to freeze first and in the worst case we will obtain that the value of the set of items obtained by the unfrozen player for the frozen one is equal to the value for the unfrozen player.
\gb{You can mention here something about the running time of the algorithm, how many more steps do we do after the modification?} (I have told something about it towards the end)
This worst case is leads to the same results obtained when we have identical valuation functions, so also if we have two freezes, than we still can obtain an EFX allocation by correctly assign the last item and by going back to the first freeze if we do not obtain an EFX allocation.
\gb{This again must be more clear, how we use the identical values case, why it is needed, why the case that you mention is the worst case}(in the beginning of section 2.2 I wrote why I have first considered the case with identical valuation functions. I did this since it was far more easier to deal with that case, rather than considering directly the general case. In the paragraph relative to the case with non identical valuation functions I explain why the case with identical valuation function is the worst one)

\paragraph{No double freeze} In the case in which we have that there is the second problematic assignment and no second freeze, we can see that we still obtain an EFX allocation by considering that in the precedent paragraph we have shown that in a general case one of the following two cases is true
\begin{itemize}
    \item if we first freeze $p_1$ and than $p_2$ we have that $v_1(F_{1,b})\le v_2(F_{1,b})$
    \item if we first freeze $p_2$ and than $p_1$ we have that $v_2(F_{2,b})\le v_1(F_{2,b})$
\end{itemize}
Let's consider that the first condition is true, than we have that when $p_1$ is unfrozen he will not envy $p_2$. If after that $p_1$ is unfrozen there are no freezes, than $p_1$ will take items with value higher or equal to the one obtained by $p_2$ for $p_1$, so at the end he will be EFX towards $p_2$ because at most $p_2$ will take the last item that will have the lower value for $p_1$ among the ones obtained by $p_2$. Instead for what concerns $p_2$, after that $p_1$ is unfrozen, he will have that $v_2(A_2) \ge v_2(A_1) - c$ because of the constraint described in equation \ref{eq:constraint-value-freeze-a-b-c}. In the iterations after that $p_1$ is unfrozen, for $p_2$ holds the same thing that holds for $p_1$ with the only exception that $p_2$ has precedence in the last iteration, so also $p_2$ will be EFX towards $p_1$. So also in this case we obtain an EFX allocation.

\subsection{Algorithm Cost}
With respect to the original algorithm that worked on two values valuation functions, we have that the number of steps the algorithm does increases because of the fact that in case of non EFX allocation we have to go back to the iteration with one of the two problematic assignments and run again the algorithm. We could have also that the first assignment of the algorithm is a problematic assignment and this would mean that we could have to run the double of the steps required by the original algorithm. 



\printbibliography %Prints bibliography

\end{document}
